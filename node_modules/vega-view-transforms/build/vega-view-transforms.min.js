!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("vega-dataflow"),require("vega-scenegraph"),require("vega-util")):"function"==typeof define&&define.amd?define(["exports","vega-dataflow","vega-scenegraph","vega-util"],e):e((t.vega=t.vega||{},t.vega.transforms=t.vega.transforms||{}),t.vega,t.vega,t.vega)}(this,function(t,e,n,o){"use strict";function r(t){e.Transform.call(this,null,t)}function a(t,e,n){return e(t.bounds.clear(),t,n)}function i(t){e.Transform.call(this,0,t)}function u(t){var e=t._signals[G];return e||(t._signals[G]=e=t.add(0)),e}function s(t){e.Transform.call(this,null,t)}function d(t){var e=t.groups,n=t.parent;return e&&1===e.size?e.get(Object.keys(e.object)[0]):e&&n?e.lookup(n):null}function l(t){e.Transform.call(this,null,t)}function f(t,e){return!(t.x2-1<e.x1||t.x1+1>e.x2||t.y2-1<e.y1||t.y1+1>e.y2)}function c(t){for(var e,n=1,o=t.length,r=t[0].bounds;n<o;r=e,++n)if(f(r,e=t[n].bounds))return!0}function h(t){var e=t.bounds;return e.width()>1&&e.height()>1}function m(t){e.Transform.call(this,null,t)}function b(t){for(var e,n,o=t.items,r=o.length,a=0,i={marks:[],rowheaders:[],rowfooters:[],colheaders:[],colfooters:[],rowtitle:null,coltitle:null};a<r;++a)if(e=o[a],n=e.items,"group"===e.marktype)switch(e.role){case L:case P:break;case R:g(n,i.rowheaders);break;case C:g(n,i.rowfooters);break;case V:g(n,i.colheaders);break;case W:g(n,i.colfooters);break;case U:i.rowtitle=n[0];break;case J:i.coltitle=n[0];break;default:g(n,i.marks)}return i}function g(t,e){for(var n=0,o=t.length;n<o;++n)e.push(t[n])}function y(t){return{x1:0,y1:0,x2:t.width||0,y2:t.height||0}}function x(t){var e=t.bounds.clone();return e.empty()?e.set(0,0,0,0):e.translate(-(t.x||0),-(t.y||0))}function p(t,e){return"x1"===e?t.x||0:"y1"===e?t.y||0:"x2"===e?(t.x||0)+(t.width||0):"y2"===e?(t.y||0)+(t.height||0):void 0}function v(t,e){return t.bounds[e]}function w(t,e,n){var r=o.isObject(t)?t[e]:t;return null!=r?r:void 0!==n?n:0}function k(t){return t<0?Math.ceil(-t):0}function M(t,e,o){function r(t,e){return Math.floor(Math.min(t,e))}function a(t,e){return Math.ceil(Math.max(t,e))}var i,u,s,d,l,f,c,h,m,g,M,B,D,E=b(e,o),_=E.marks,O="flush"===o.bounds,j=O?y:x,q=new n.Bounds(0,0,0,0),A=w(o.align,"column"),I=w(o.align,"row"),S=w(o.padding,"column"),F=w(o.padding,"row"),G=o.offset,H=e.columns||o.columns||_.length,L=H<0?1:Math.ceil(_.length/H),P=L*H,R=[],C=[],U=[],V=[],W=_.length;for(u=0;u<H;++u)C[u]=0;for(u=0;u<L;++u)V[u]=0;for(u=0;u<W;++u)l=j(_[u]),d=~~(u/H),c=(s=u%H)?Math.ceil(j(_[u-1]).x2):0,h=d?Math.ceil(j(_[u-H]).y2):0,C[s]=Math.max(C[s],c),V[d]=Math.max(V[d],h),R.push(S+k(l.x1)),U.push(F+k(l.y1)),t.dirty(_[u]);for(u=0;u<W;++u)u%H==0&&(R[u]=0),u<H&&(U[u]=0);if("each"===A)for(s=1;s<H;++s){for(D=0,u=s;u<W;u+=H)D<R[u]&&(D=R[u]);for(u=s;u<W;u+=H)R[u]=D+C[s]}else if("all"===A){for(B=0,s=1;s<H;++s)B<C[s]&&(B=C[s]);for(D=0,u=0;u<W;++u)u%H&&D<R[u]&&(D=R[u]);for(u=0;u<W;++u)u%H&&(R[u]=D+B)}else for(s=1;s<H;++s)for(u=s;u<W;u+=H)R[u]+=C[s];if("each"===I)for(d=1;d<L;++d){for(D=0,i=(u=d*H)+H;u<i;++u)D<U[u]&&(D=U[u]);for(u=d*H;u<i;++u)U[u]=D+V[d]}else if("all"===I){for(B=0,d=1;d<L;++d)B<V[d]&&(B=V[d]);for(D=0,u=H;u<W;++u)D<U[u]&&(D=U[u]);for(u=H;u<W;++u)U[u]=D+B}else for(d=1;d<L;++d)for(i=(u=d*H)+H;u<i;++u)U[u]+=V[d];for(m=0,u=0;u<W;++u)c=(f=_[u]).x||0,f.x=m=R[u]+(u%H?m:0),f.bounds.translate(m-c,0);for(s=0;s<H;++s)for(g=0,u=s;u<W;u+=H)h=(f=_[u]).y||0,f.y=g+=U[u],f.bounds.translate(0,g-h);for(u=0;u<W;++u)_[u].mark.bounds.clear();for(u=0;u<W;++u)f=_[u],t.dirty(f),q.union(f.mark.bounds.union(f.bounds));j=O?p:v,M=w(o.headerBand,"row",null),m=T(t,E.rowheaders,_,H,L,-w(G,"rowHeader"),r,0,j,"x1",0,H,1,M),M=w(o.headerBand,"column",null),g=T(t,E.colheaders,_,H,H,-w(G,"columnHeader"),r,1,j,"y1",0,1,H,M),M=w(o.footerBand,"row",null),T(t,E.rowfooters,_,H,L,w(G,"rowFooter"),a,0,j,"x2",H-1,H,1,M),M=w(o.footerBand,"column",null),T(t,E.colfooters,_,H,H,w(G,"columnFooter"),a,1,j,"y2",P-H,1,H,M),E.rowtitle&&(D=m-w(G,"rowTitle"),M=w(o.titleBand,"row",.5),z(t,E.rowtitle,D,0,q,M)),E.coltitle&&(D=g-w(G,"columnTitle"),M=w(o.titleBand,"column",.5),z(t,E.coltitle,D,1,q,M))}function T(t,e,n,o,r,a,i,u,s,d,l,f,c,h){var m,b,g,y,x,p,v,w,k,M=n.length,T=0,z=0;for(m=l;m<M;m+=f)n[m]&&(T=i(T,s(n[m],d)));if(!e.length)return T;for(e.length>r&&(t.warn("Grid headers exceed limit: "+r),e=e.slice(0,r)),T+=a,b=0,y=e.length;b<y;++b)t.dirty(e[b]),e[b].mark.bounds.clear();for(m=l,b=0,y=e.length;b<y;++b,m+=f){for(x=(p=e[b]).mark.bounds,g=m;null==(v=n[g]);g-=c);u?(w=null==h?v.x:Math.round(v.bounds.x1+h*v.bounds.width()),k=T):(w=T,k=null==h?v.y:Math.round(v.bounds.y1+h*v.bounds.height())),x.union(p.bounds.translate(w-(p.x||0),k-(p.y||0))),p.x=w,p.y=k,t.dirty(p),z=i(z,x[d])}return z}function z(t,e,n,o,r,a){if(e){t.dirty(e);var i=n,u=n;o?i=Math.round(r.x1+a*r.width()):u=Math.round(r.y1+a*r.height()),e.bounds.translate(i-(e.x||0),u-(e.y||0)),e.mark.bounds.clear().union(e.bounds),e.x=i,e.y=u,t.dirty(e)}}function B(t){e.Transform.call(this,null,t)}function D(t,e,o){var r,a,i,u,s,d,l=e.items,f=Math.max(0,e.width||0),c=Math.max(0,e.height||0),h=(new n.Bounds).set(0,0,f,c),m=h.clone(),b=h.clone(),g=h.clone(),y=[];for(s=0,d=l.length;s<d;++s)switch((a=l[s]).role){case et:m.union(u=j(t,a,f,c)),(_(a)?b:g).union(u);break;case nt:r=a;break;case rt:y.push(a);break;case ot:case at:case it:case ut:case st:case dt:b.union(a.bounds),g.union(a.bounds);break;default:h.union(a.bounds)}if(r&&(m.union(u=q(t,r,m)),(_(r)?b:g).union(u)),y.length)for(i={left:0,right:0,top:0,bottom:0,margin:o.legendMargin||8},s=0,d=y.length;s<d;++s)if(u=A(t,y[s],i,b,g,f,c),o.autosize&&o.autosize.type===K){var x=y[s].items[0].datum.orient;x===Z||x===$?h.add(u.x1,0).add(u.x2,0):x!==Y&&x!==tt||h.add(0,u.y1).add(0,u.y2)}else h.union(u);h.union(b).union(g).union(m),I(t,e,h,o)}function E(t,e,n){return t[e]===n?0:(t[e]=n,1)}function _(t){var e=t.items[0].datum.orient;return e===Z||e===$}function O(t){var e=+t.grid;return[t.ticks?e++:-1,t.labels?e++:-1,e+ +t.domain]}function j(t,e,o,r){var a,i,u=e.items[0],s=u.datum,d=s.orient,l=O(s),f=u.range,c=u.offset,h=u.position,m=u.minExtent,b=u.maxExtent,g=s.title&&u.items[l[2]].items[0],y=u.titlePadding,x=u.bounds,p=0,v=0;switch(ft.clear().union(x),x.clear(),(a=l[0])>-1&&x.union(u.items[a].bounds),(a=l[1])>-1&&x.union(u.items[a].bounds),d){case Y:p=h||0,v=-c,i=Math.max(m,Math.min(b,-x.y1)),g&&(g.auto?(i+=y,g.y=-i,i+=g.bounds.height()):x.union(g.bounds)),x.add(0,-i).add(f,0);break;case Z:p=-c,v=h||0,i=Math.max(m,Math.min(b,-x.x1)),g&&(g.auto?(i+=y,g.x=-i,i+=g.bounds.width()):x.union(g.bounds)),x.add(-i,0).add(0,f);break;case $:p=o+c,v=h||0,i=Math.max(m,Math.min(b,x.x2)),g&&(g.auto?(i+=y,g.x=i,i+=g.bounds.width()):x.union(g.bounds)),x.add(0,0).add(i,f);break;case tt:p=h||0,v=r+c,i=Math.max(m,Math.min(b,x.y2)),g&&(g.auto?(i+=y,g.y=i,i+=g.bounds.height()):x.union(g.bounds)),x.add(0,0).add(f,i);break;default:p=u.x,v=u.y}return n.boundStroke(x.translate(p,v),u),E(u,"x",p+lt)|E(u,"y",v+lt)&&(u.bounds=ft,t.dirty(u),u.bounds=x,t.dirty(u)),u.mark.bounds.clear().union(x)}function q(t,e,n){var o=e.items[0],r=o.datum.orient,a=o.offset,i=o.bounds,u=0,s=0;switch(ft.clear().union(i),r){case Y:u=o.x,s=n.y1-a;break;case Z:u=n.x1-a,s=o.y;break;case $:u=n.x2+a,s=o.y;break;case tt:u=o.x,s=n.y2+a;break;default:u=o.x,s=o.y}return i.translate(u-o.x,s-o.y),E(o,"x",u)|E(o,"y",s)&&(o.bounds=ft,t.dirty(o),o.bounds=i,t.dirty(o)),e.bounds.clear().union(i)}function A(t,e,o,r,a,i,u){var s,d,l,f=e.items[0],c=f.datum.orient,h=f.offset,m=f.bounds,b=0,g=0;switch(c===Y||c===tt?(l=a,b=o[c]):c!==Z&&c!==$||(l=r,g=o[c]),ft.clear().union(m),m.clear(),f.items.forEach(function(t){m.union(t.bounds)}),s=Math.round(m.width())+2*f.padding-1,d=Math.round(m.height())+2*f.padding-1,c){case Z:b-=s+h-Math.floor(l.x1),o.left+=d+o.margin;break;case $:b+=h+Math.ceil(l.x2),o.right+=d+o.margin;break;case Y:g-=d+h-Math.floor(l.y1),o.top+=s+o.margin;break;case tt:g+=h+Math.ceil(l.y2),o.bottom+=s+o.margin;break;case"top-left":b+=h,g+=h;break;case"top-right":b+=i-s-h,g+=h;break;case"bottom-left":b+=h,g+=u-d-h;break;case"bottom-right":b+=i-s-h,g+=u-d-h;break;default:b=f.x,g=f.y}return n.boundStroke(m.set(b,g,b+s,g+d),f),E(f,"x",b)|E(f,"width",s)|E(f,"y",g)|E(f,"height",d)&&(f.bounds=ft,t.dirty(f),f.bounds=m,t.dirty(f)),f.mark.bounds.clear().union(m)}function I(t,e,n,o){var r=o.autosize||{},a=r.type,i=t._width,u=t._height,s=t.padding();if(!(t._autosize<1)&&a){var d=Math.max(0,e.width||0),l=Math.max(0,Math.ceil(-n.x1)),f=Math.max(0,Math.ceil(n.x2-d)),c=Math.max(0,e.height||0),h=Math.max(0,Math.ceil(-n.y1)),m=Math.max(0,Math.ceil(n.y2-c));r.contains===X&&(i-=s.left+s.right,u-=s.top+s.bottom),a===Q?(l=0,h=0,d=i,c=u):a===K?(d=Math.max(0,i-l-f),c=Math.max(0,u-h-m)):a===N&&(i=d+l+f,u=c+h+m),t._resizeView(i,u,d,c,[l,h],r.resize)}}var S=o.inherits(r,e.Transform),F=new n.Bounds;S.transform=function(t,e){var o,r=e.dataflow,i=t.mark,u=i.marktype,s=n.Marks[u],d=s.bound,l=i.clip,f=i.bounds;return s.nested?(i.items.length&&r.dirty(i.items[0]),f=a(i,d),i.items.forEach(function(t){t.bounds.clear().union(f)})):"group"===u||t.modified()?(e.visit(e.MOD,function(t){r.dirty(t)}),f.clear(),i.items.forEach(function(t){f.union(a(t,d))})):(o=e.changed(e.REM),e.visit(e.ADD,function(t){f.union(a(t,d))}),e.visit(e.MOD,function(t){o=o||f.alignsWith(t.bounds),r.dirty(t),f.union(a(t,d))}),o&&!l&&(f.clear(),i.items.forEach(function(t){f.union(t.bounds)}))),l&&f.intersect(F.set(0,0,i.group.width,i.group.height)),e.modifies("bounds")};var G=":vega_identifier:";i.Definition={type:"Identifier",metadata:{modifies:!0},params:[{name:"as",type:"string",required:!0}]},o.inherits(i,e.Transform).transform=function(t,e){var n=u(e.dataflow),o=n.value,r=t.as;return e.visit(e.ADD,function(t){t[r]||(t[r]=++o)}),n.set(this.value=o),e},o.inherits(s,e.Transform).transform=function(t,e){var o=this.value;o||((o=e.dataflow.scenegraph().mark(t.markdef,d(t),t.index)).group.context=t.context,t.context.group||(t.context.group=o.group),o.source=this,this.value=o);var r="group"===o.marktype?n.GroupItem:n.Item;return e.visit(e.ADD,function(t){r.call(t,o)}),o.items=e.source,e};var H={parity:function(t){return t.filter(function(t,e){return e%2?t.opacity=0:1})},greedy:function(t){var e;return t.filter(function(t,n){return n&&f(e.bounds,t.bounds)?t.opacity=0:(e=t,1)})}};o.inherits(l,e.Transform).transform=function(t,e){var n=H[t.method]||H.parity,r=e.materialize(e.SOURCE).source,a=r;if(a){if("greedy"===t.method&&(a=r=r.filter(h)),a.length>=3&&c(a)){e=e.reflow(t.modified()).modifies("opacity");do{a=n(a)}while(a.length>=3&&c(a));a.length<3&&!o.peek(r).opacity&&(a.length>1&&(o.peek(a).opacity=0),o.peek(r).opacity=1)}return e}},o.inherits(m,e.Transform).transform=function(t,e){var n=e.dataflow;if(e.visit(e.ALL,function(t){n.dirty(t)}),e.fields&&e.fields.zindex){var o=e.source&&e.source[0];o&&(o.mark.zdirty=!0)}};var L="axis",P="legend",R="row-header",C="row-footer",U="row-title",V="column-header",W="column-footer",J="column-title",K="fit",N="pad",Q="none",X="padding",Y="top",Z="left",$="right",tt="bottom",et="axis",nt="title",ot="frame",rt="legend",at="scope",it="row-header",ut="row-footer",st="column-header",dt="column-footer",lt=.5,ft=new n.Bounds;o.inherits(B,e.Transform).transform=function(t,e){var n=e.dataflow;return t.mark.items.forEach(function(e){t.layout&&M(n,e,t.layout),D(n,e,t)}),e},t.bound=r,t.identifier=i,t.mark=s,t.overlap=l,t.render=m,t.viewlayout=B,Object.defineProperty(t,"__esModule",{value:!0})});