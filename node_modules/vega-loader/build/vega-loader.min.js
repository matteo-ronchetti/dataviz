!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports,require("vega-util"),require("d3-request"),require("d3-dsv"),require("topojson"),require("d3-time-format")):"function"==typeof define&&define.amd?define(["exports","vega-util","d3-request","d3-dsv","topojson","d3-time-format"],r):r(e.vega=e.vega||{},e.vega,e.d3,e.d3,e.topojson,e.d3)}(this,function(e,r,t,n,o,i){"use strict";function u(e,t){return r.extend({},e.options,t)}function f(e,r){var t=this;return t.sanitize(e,r).then(function(e){var n=e.href;return e.localFile?t.file(n):t.http(n,r)})}function s(e,t){return t=u(this,t),new Promise(function(n,o){var i,u,f,s,a={href:null};null!=e&&"string"==typeof e?(u=N.test(e),(s=t.baseURL)&&!u&&(d(e,"/")||"/"===s[s.length-1]||(e="/"+e),e=s+e),f=(i=d(e,P))||"file"===t.mode||"http"!==t.mode&&!u&&c(),i?e=e.slice(P.length):d(e,"//")&&("file"===t.defaultProtocol?(e=e.slice(2),f=!0):e=(t.defaultProtocol||"http")+":"+e),Object.defineProperty(a,"localFile",{value:!!f}),a.href=e,n(a)):o("Sanitize failure, invalid URI: "+r.stringValue(e))})}function a(e,r){return r=u(this,r),new Promise(function(n,o){var i,u=t.request(e);for(i in r.headers)u.header(i,r.headers[i]);q.forEach(function(e){r[e]&&u[e](r[e])}),u.on("error",function(r){o(r||"Error loading URL: "+e)}).on("load",function(e){var r=e&&e.responseText;e&&0!==e.status?n(r):o(r||"Error")}).get()})}function l(e){return new Promise(function(r,t){var n=c();n?n.readFile(e,function(e,n){e?t(e):r(n)}):t("No file system access for "+e)})}function c(){var e="function"==typeof require&&require("fs");return e&&r.isFunction(e.readFile)?e:null}function d(e,r){return null!=e&&0===e.lastIndexOf(r,0)}function p(e,r){var t,n,o,i,u=w.slice();for(n=0,o=e.length;n<o;++n){for(t=r?e[n][r]:e[n],i=0;i<u.length;++i)m(t)&&!u[i](t)&&(u.splice(i,1),--i);if(0===u.length)return"string"}return S[w.indexOf(u[0])]}function h(e,r){return r.reduce(function(r,t){return r[t]=p(e,t),r},{})}function m(e){return null!=e&&e===e}function v(e){return!(isNaN(+e)||e instanceof Date)}function g(e){return function(t,n){var o={delimiter:e};return y(t,n?r.extend(n,o):o)}}function y(e,t){return t.header&&(e=t.header.map(r.stringValue).join(t.delimiter)+"\n"+e),n.dsvFormat(t.delimiter).parse(e+"")}function b(e){return!("function"!=typeof Buffer||!r.isFunction(Buffer.isBuffer))&&Buffer.isBuffer(e)}function j(e,r){return r&&r.copy?JSON.parse(JSON.stringify(e)):e}function O(e,r,t){t=t||i.timeParse;var n,o,u,f,s,a,l,c=e.columns||Object.keys(e[0]);for("auto"===r&&(r=h(e,c)),n=(c=Object.keys(r)).map(function(e){var n,o,u=r[e];if(u&&(0===u.indexOf("date:")||0===u.indexOf("utc:")))return n=u.split(/:(.+)?/,2),("'"===(o=n[1])[0]&&"'"===o[o.length-1]||'"'===o[0]&&'"'===o[o.length-1])&&(o=o.slice(1,-1)),"utc"===n[0]?i.utcParse(o):t(o);if(!x[u])throw Error("Illegal format pattern: "+e+":"+u);return x[u]}),f=0,a=e.length,l=c.length;f<a;++f)for(o=e[f],s=0;s<l;++s)o[u=c[s]]=n[s](o[u])}var N=/^([A-Za-z]+:)?\/\//,P="file://",q=["mimeType","responseType","user","password"],x={boolean:r.toBoolean,integer:r.toNumber,number:r.toNumber,date:r.toDate,string:r.toString},w=[function(e){return"true"===e||"false"===e||!0===e||!1===e},function(e){return v(e)&&(e=+e)==~~e},v,function(e){return!isNaN(Date.parse(e))}],S=["boolean","integer","number","date"],T=function(e,t){var n=t&&t.property?r.field(t.property):r.identity;return r.isObject(e)&&!b(e)?j(n(e)):n(JSON.parse(e))},F={dsv:y,csv:g(","),tsv:g("\t"),json:T,topojson:function(e,t){var n,i;return e=T(e,t),t&&(i=t.feature)?(n=e.objects[i])?o.feature(e,n).features:r.error("Invalid TopoJSON object: "+i):t&&(i=t.mesh)?(n=e.objects[i])?[o.mesh(e,n)]:r.error("Invalid TopoJSON object: "+i):void r.error("Missing TopoJSON feature or mesh parameter.")}},B=function(e,r){return arguments.length>1?(F[e]=r,this):F.hasOwnProperty(e)?F[e]:null};e.loader=function(e){return{options:e||{},sanitize:s,load:f,file:l,http:a}},e.read=function(e,t,n){var o=B((t=t||{}).type||"json");return o||r.error("Unknown data format type: "+t.type),e=o(e,t),t.parse&&O(e,t.parse,n),e.hasOwnProperty("columns")&&delete e.columns,e},e.inferType=p,e.inferTypes=h,e.typeParsers=x,e.formats=B,Object.defineProperty(e,"__esModule",{value:!0})});